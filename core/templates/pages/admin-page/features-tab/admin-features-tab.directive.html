<div *ngFor="let featureFlag of featureFlags; index as featureIndex;" class="container oppia-page-card oppia-long-text protractor-test-feature-flag">
  <h2 style="border-bottom: 1px solid #e5e5e5;" class="feature-name">{{featureFlag.name}}</h2>
  <div class="row" style="margin-top: 5px">
    <div class="col-2"><b>Description:</b></div>
    <div class="col-10" style="overflow-wrap: anywhere;">{{featureFlag.description}}</div>
  </div>
  <div class="row" style="margin-top: 5px">
    <div class="col-2"><b>Feature Stage:</b></div>
    <div class="col-10">{{featureFlag.featureStage}}</div>
  </div>
  <div class="row" style="margin-top: 5px">
    <div class="col-2"><b>Default:</b></div>
    <div class="col-10">{{featureFlag.defaultValue ? 'Enabled' : 'Disabled'}}</div>
  </div>
  <div class="row" style="margin-top: 5px">
    <div class="col-2" style="display: flex; flex-direction: column;">
      <b>Rules:</b>
      <button class="btn btn-secondary" style="margin-top: 5;" (click)="addNewRuleToTop(featureFlag)">Add To Top</button>
      <button class="btn btn-secondary protractor-test-feature-add-rule-button" style="margin-top: 5;" (click)="addNewRuleToBottom(featureFlag)">Add To Bottom</button>
    </div>
    <div class="col-10">
      <div *ngIf="featureFlag.rules.length === 0" class="protractor-test-no-rule-indicator">
        No rule.
      </div>
      <!-- Rules -->
      <div *ngFor="let rule of featureFlag.rules; index as ruleIndex" class="container" style="margin-bottom: 15px;">
        <div class="row">
          <div class="col-2 oppia-feature-tab-center">
            <div class="row">
              <div class="col-6 oppia-feature-tab-vertical-center">
                <button class="btn btn-secondary protractor-test-remove-rule-button" (click)="removeRule(featureFlag, ruleIndex)">x</button>
              </div>
              <div class="col-6" style="display: flex; flex-direction: column; justify-content: space-around; min-height: 100px;">
                <button
                    class="btn btn-secondary"
                    *ngIf="ruleIndex > 0"
                    (click)="moveRuleUp(featureFlag, ruleIndex)">↑</button>
                <button
                    class="btn btn-secondary"
                    *ngIf="ruleIndex + 1 < featureFlag.rules.length"
                    (click)="moveRuleDown(featureFlag, ruleIndex)">↓</button>
              </div>
            </div>
          </div>
          <div class="col-10" style="border: 1px solid #e5e5e5; padding-top: 10px; padding-bottom: 10px;">
            <div class="row">
              <div class="col-2"><b>If Matched:</b></div>
              <div class="col-10">
                <select name="" id="" [(ngModel)]="rule.valueWhenMatched" class="protractor-test-value-selector">
                  <option [ngValue]="true">Enabled</option>
                  <option [ngValue]="false">Disabled</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top: 10px;">
              <div class="col-2">
                <b>Filters:</b>
                <button class="btn btn-secondary" style="margin-left: 10px;" (click)="addNewFilter(rule)">+</button>
              </div>
              <div class="col-10">
                <div *ngIf="rule.filters.length === 0">No filter.</div>
                <!-- Filters -->
                <div *ngFor="let filter of rule.filters; index as filterIndex" class="container">
                  <div
                      *ngIf="filterIndex > 0"
                      class="row">
                    <div class="col-12 oppia-feature-tab-conjunction-indicator">
                      <div class="horizontal-line"></div>
                      AND
                      <div class="horizontal-line"></div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-1 oppia-feature-tab-center">
                      <button class="btn btn-secondary" (click)="removeFilter(rule, filterIndex)">x</button>
                    </div>
                    <div class="col-11" style="border: 1px solid #e5e5e5; padding-top: 10px; padding-bottom: 10px;">
                      <div class="row">
                        <div class="col-2"><b>Type:</b></div>
                        <div class="col-10">
                          <select
                              [(ngModel)]="filter.type"
                              (change)="onFilterTypeSelectionChanged(filter)">
                            <option
                                *ngFor="let filterType of availableFilterTypes"
                                [value]="filterType.toString()">
                              {{filterTypeToContext[filterType].displayName}}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="row" style="margin-top: 10px;">
                        <div class="col-4">
                          <b>Conditions:</b>
                          <button class="btn btn-secondary" style="margin-left: 10px;" (click)="addNewCondition(filter)">+</button>
                        </div>
                        <div class="col-8">
                          <!-- Conditions -->
                          <div *ngFor="let condition of filter.conditions; index as conditionIndex">
                            <div
                                *ngIf="conditionIndex > 0"
                                class="oppia-feature-tab-conjunction-indicator">
                              <div class="horizontal-line"></div>
                              OR
                              <div class="horizontal-line"></div>
                            </div>
                            <div class="oppia-feature-tab-condition-container">
                              <button class="btn btn-secondary" (click)="removeCondition(filter, conditionIndex)" style="margin-right: 20px;">x</button>
                              <div>
                                <select [(ngModel)]="filter.conditions[conditionIndex][0]" style="margin-right: 5px;">
                                  <option
                                      *ngFor="let op of filterTypeToContext[filter.type].operators"
                                      [value]="op">
                                    {{op}}
                                </option>
                                </select>
                                <select
                                    *ngIf="!!filterTypeToContext[filter.type].options"
                                    [(ngModel)]="filter.conditions[conditionIndex][1]">
                                  <ng-container *ngFor="let option of filterTypeToContext[filter.type].options">
                                    <option
                                        *ngIf="!filterTypeToContext[filter.type].optionFilter || filterTypeToContext[filter.type].optionFilter(featureFlag, option)"
                                        [value]="option">{{option}}</option>
                                  </ng-container>
                                </select>
                                <ng-container
                                    *ngIf="!filterTypeToContext[filter.type].options">
                                  <input
                                      [(ngModel)]="filter.conditions[conditionIndex][1]"
                                      [placeholder]="filterTypeToContext[filter.type].placeholder"
                                      style="max-width: 100px;"/>
                                  <ng-container *ngIf="filterTypeToContext[filter.type].inputRegex">
                                    <span
                                        class="oppia-feature-tab-input-error"
                                        *ngIf="!filterTypeToContext[filter.type].inputRegex.test(filter.conditions[conditionIndex][1])">
                                      <span>!</span>
                                      <div class="tooltip">
                                        Expected to match {{filterTypeToContext[filter.type].inputRegex}}
                                      </div>
                                    </span>
                                  </ng-container>
                                </ng-container>
                              </div>
                            </div>
                          </div>
                          <div *ngIf="filter.conditions.length === 0" class="row">
                            <div class="col">No condition specified.</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row oppia-feature-tab-control-buttons-container" style="margin-top: 10px;">
    <!-- Control Buttons -->
    <button class="btn btn-primary protractor-test-save-button" (click)="updateFeatureRulesAsync(featureFlag)">Save</button>
    <button class="btn btn-secondary" (click)="clearChanges(featureFlag)" style="margin-left: 5px;">Clear Changes</button>
  </div>
</div>

<div *ngIf="featureFlags.length === 0" class="oppia-page-card oppia-long-text protractor-test-no-feature" style="max-width: 1050px">
  No platform features are available.
</div>

<div *ngIf="isDummyFeatureEnabled" class="oppia-dev-mode protractor-test-angular-dummy-feature-indicator" style="bottom: 10px;">
  Angular: Dummy Feature Enabled
  <span *ngIf="isDummyApiEnabled" class="protractor-test-angular-dummy-handler-indicator">, Dummy Handler Enabled.</span>
</div>


<style>
  .oppia-feature-tab-center {
    align-items: center;
    display: flex;
    justify-content: center;
  }

  .oppia-feature-tab-horizon-center {
    display: flex;
    justify-content: center;
  }

  .oppia-feature-tab-vertical-center {
    align-items: center;
    display: flex;
  }

  .oppia-feature-tab-control-buttons-container {
    align-items: center;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: flex-end;
    padding-top: 10px;
  }

  .oppia-feature-tab-condition-container {
    align-items: center;
    display: flex;
    width: 100%;
  }

  .oppia-feature-tab-conjunction-indicator {
    align-items: center;
    display: flex;
    font-size: 12px;
    justify-content: space-between;
    margin-top: 10px;
    margin-bottom: 10px;
    width: 100%;
  }

  .oppia-feature-tab-conjunction-indicator > .horizontal-line {
    border-bottom: 1px dotted #e5e5e5;
    height: 0;
    flex-grow: 1;
  }

  .oppia-feature-tab-input-error {
    position: relative;
    margin-left: 15px;
  }

  .oppia-feature-tab-input-error span {
    color: #ff6347;
    font-weight: bold;
  }

  .oppia-feature-tab-input-error .tooltip {
    opacity: 0;
    position: absolute;
    left: -50%;
    background-color: #f5f5f5;
    border: 1px solid #ff6347;
    font-size: 14px;
    border-radius: 3px;
    padding: 5px;
    width: 200px;
  }

  .oppia-feature-tab-input-error:hover .tooltip {
    opacity: 1;
  }
</style>
